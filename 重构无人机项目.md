# 重构项目，从开始到失败
## 项目背景
无人机仿真环境项目(后简称“项目”)，是我导的科研项目的备备备备选环境之一。我导的项目是研究协同无人机群的抗干扰强化学习算法，因此他希望我能写一个仿真环境在后期能够接入并测试强化学习算法。以下是我导提出的需求列表。

- 基于我导提供的2D版本的、gym风格的仿真环境，升级成3D版本，并让单个无人机随机移动，用matliplot库画出连续动画。
- 细分场景，增加更多的建筑。地图大小要有三个型号，10*10、50*50、100*100。
- 在50*50的场景中，让两个无人机按照指定路线移动到两个不同的目标点。
- 在50*50的场景中，让4组无人机（34架无人机）飞到各自指定位置组成五环形状并记录所有无人机的运行轨迹。
- 在50*50的场景中，让4组无人机（32架无人机）飞到对面区域并记录所有无人机的飞行轨迹。
## 当前问题
- 由于需求是逐步提出的，每次更新我都只能在原有代码上进行，这导致我的代码没有提前规划好，冗余度高、耦合度高、性能极差。很多类在更新的过程中功能变得复杂，需要进行功能分割。
- 在实现需求时，我开发了很多小工具，比如地图修改器，地图预览器，无人机初始位置预览器等我希望整理出来放在单独的tool文件夹中。
- 需求3、4、5凡是设计无人机移动的，我都是手动写代码让无人机按步骤移动，这很繁琐，也很低效。我希望设计一个简单的算法，让他自动运行。
- 建筑写死在.py文件中的大数组中，读取速度慢。改为写在csv文件中。且数据结构没有经过设计，性能差。
- 需要画出所有无人机的飞行轨迹，用matliplot库画非常不流畅，需要换更高级的图形库。如果还是采用matplotlib怎么修改才能让性能提升。
## 重构目的
- 提高扩展性，可以接入强化学习算法开展实验或其他一些列新的需求
- 减低耦合度，重新规划一下代码来减少耦合度
- 提高工作效率，整合一下小工具，减少调试地图的工作量；设计一个适用的运动函数，让无人机自动寻路
- 提高画图流程度
## 开始重构
### 分割功能
一开始我热血上头，在没有梳理整个程序类图的情况下直接开干，把所有功能都用类的方式独立开来。比如说，原有的UAVENV类中的Recorder函数单独分离出来，作为一个新类用来记录所有无人机的飞行轨迹；将main函数里的env_t写成类，我天真的以为这样分离出来就可以减少耦合，但其实并没有，类完全没有起到他该有的作用，大多时候我如果需要这个类的东西，我会直接把整个类作为参数传入，这样就能随心所欲的操作整个类，这样做虽然说是方便了自己，但整个程序就非常的混乱，复杂度很高。功能虽然被拆分成了一个类，但模块之间的依赖关系非常混乱，经常出现链式调用，没有真正的解耦。
### 开发小工具
在开发小工具时，我其实翻来覆去改写代码多次，为什么？就是因为我没有在一开始确定我要如何存储我的地图信息。第一次修改时，我在想要不别把信息保存在数组里吧，每次都要操作这么大数组会不会很耗内存和CPU啊，还是存在csv里吧。这其实是我犯蠢了也可能是因为我计算机操作系统知识不太牢固，放在csv里的话每次读写都需要从磁盘上调取，而放在数组里虽然会占用内存但读写速度快，但由于我设计的程序有问题会导致绘图时内存不断减少，最终导致slow page swap，所以放在数组里也有弊端，具体选哪个可能需要明确到底为什么导致的绘图速度慢；第二次修改时，我原本是打算照着以前的方式记录建筑物信息，两个数组，一个数组记录建筑物的高度，另一个数组记录建筑物的底部四点位置。但后来我发现了使用matplotlib库里的ax.bar3d函数的话就可以只记录第一个数组。总之反反复复修改多次，而且我当时开发了一个复杂版一个简易版的地图创建工具，所以在这浪费了非常多时间，特别是复杂版的，我在未完成项目时就已经给他配上了parser这些乱七八糟的，导致我整的非常慢。
### 重写运动算法
我设计了一个简单的运动算法，就是先进行检测看动作是否合理（是否在地图外，是否会撞击建筑，是否会撞击其他无人机），如果动作合理，就朝目标方向启动，如果不合理就要向上抬升0.2的高度。我把原项目中各种七七八八的函数全部集合在动作检测类中。
### 运行
当我满怀期待，累死累活的运行了这个项目，结果竟然还无法跑完demo就卡死了,比原来的还差。怎么会这样呢？我分析是：
- 过度解耦合导致额外的性能开销。类、函数的调用会造成额外的开销，尤其是链式调用。
- 没有优化记录功能，要限制一下record功能。
- 要优化一下地图信息的数据结构
- 过早的进行优化

## 反思
没事，小问题。失败是成功之母嘛，下次重构时做到以下几点，不信还是失败：
- 使用python的性能调优工具，看到底是哪一个部分需要调优，而不是一股脑把整个都给改写了
- 用类图去设计程序的结构，预先去设计类的接口与关系
- 在分割功能前先进行评估，是否有必要解耦
- 分阶段进行优化，一步一步的优化先从最重要的地方优化
- 尝试使用设计模式
  
